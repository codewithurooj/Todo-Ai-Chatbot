# Implementation Plan: AI-Powered Todo Chatbot

**Branch**: `001-chatbot` | **Date**: 2025-12-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-chatbot/spec.md`

## Summary

Implement a conversational AI-powered todo chatbot that enables users to manage tasks through natural language interactions. The system uses OpenAI Agents SDK for intent detection and response generation, MCP tools for task operations, and maintains conversation history in a stateless architecture with Neon PostgreSQL as the single source of truth.

## Technical Context

**Language/Version**: Python 3.13+
**Primary Dependencies**: FastAPI, SQLModel, OpenAI Agents SDK, Official MCP SDK (Python), Better Auth, UV package manager
**Storage**: Neon Serverless PostgreSQL
**Testing**: pytest (unit, integration, and end-to-end tests)
**Target Platform**: Cloud-native (Vercel for frontend, Python hosting for backend)
**Project Type**: Web application (frontend + backend)
**Performance Goals**:
- Chat endpoint response time: < 3 seconds (p95)
- Database queries: < 500ms
- Support 100 concurrent users without degradation

**Constraints**:
- Stateless architecture (no server-side session storage)
- All state persisted to database
- JWT-based authentication (no sticky sessions)
- Natural language only (no command syntax)

**Scale/Scope**:
- Multi-user system with user isolation
- Support for unlimited tasks per user
- Conversation history maintained indefinitely
- 5 core user stories (P1: Create, View, Complete; P2: Delete, Update; P3: Multi-turn context)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… I. Spec-Driven Development (NON-NEGOTIABLE)
- **Status**: PASS
- **Evidence**: Feature spec exists at `specs/001-chatbot/spec.md`, this plan will generate tasks.md, all code will be generated via Claude Code from tasks
- **Verification**: No manual coding permitted; all implementation via specification refinement

### âœ… II. Conversational-First Interface
- **Status**: PASS
- **Evidence**: All 5 user stories require natural language understanding; FR-001 through FR-006 specify intent interpretation without command syntax
- **Design Impact**: OpenAI Agents SDK will handle natural language processing; system prompt will define conversational behavior

### âœ… III. Stateless Architecture
- **Status**: PASS
- **Evidence**: Architecture stores all conversation history in database (FR-013, FR-014); chat endpoint fetches history on each request
- **Design Impact**: No in-memory session state; JWT tokens for authentication; database connection pooling only

### âœ… IV. MCP Tool Architecture
- **Status**: PASS
- **Evidence**: All task operations (add, list, update, delete, complete) will be exposed as MCP tools per FR-007 through FR-011
- **Design Impact**: OpenAI agent invokes MCP tools (not direct database calls); tools have explicit schemas

### âœ… V. Database as Single Source of Truth
- **Status**: PASS
- **Evidence**: All entities defined in spec (Task, Conversation, Message, User); database schema includes user_id, timestamps per constitution
- **Design Impact**: SQLModel for ORM; DATABASE_URL environment variable; no caching of user data

### âœ… VI. Authentication and Security
- **Status**: PASS
- **Evidence**: FR-021 through FR-023 require authentication; all API endpoints validate JWT tokens; user isolation enforced (FR-012)
- **Design Impact**: Better Auth for signup/signin; BETTER_AUTH_SECRET shared between frontend and backend; user_id in all queries

### âœ… VII. AI Agent Integration
- **Status**: PASS
- **Evidence**: FR-001 through FR-006 require intent detection from natural language; agent determines tool calls based on user message
- **Design Impact**: OpenAI Agents SDK with configurable model (gpt-4o or gpt-4o-mini); no hardcoded if/else for intent

**Constitution Compliance**: âœ… **ALL 7 PRINCIPLES MET**

## Project Structure

### Documentation (this feature)

```text
specs/001-chatbot/
â”œâ”€â”€ spec.md              # Feature specification (exists)
â”œâ”€â”€ plan.md              # This file (implementation plan)
â”œâ”€â”€ research.md          # Phase 0: Technology best practices research
â”œâ”€â”€ data-model.md        # Phase 1: Database schema design
â”œâ”€â”€ quickstart.md        # Phase 1: Implementation quick reference
â”œâ”€â”€ contracts/           # Phase 1: API specifications and MCP tool schemas
â”‚   â”œâ”€â”€ api-endpoints.md         # REST API endpoint specifications
â”‚   â”œâ”€â”€ mcp-tools.md             # MCP tool interface definitions
â”‚   â””â”€â”€ agent-orchestrator.md   # AI agent architecture specification
â””â”€â”€ tasks.md             # Phase 2: Generated by /sp.tasks command (NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                  # FastAPI application entry point
â”‚   â”œâ”€â”€ config.py                # Environment variables and configuration
â”‚   â”œâ”€â”€ database.py              # SQLModel database setup and session management
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py              # Task SQLModel schema
â”‚   â”‚   â”œâ”€â”€ conversation.py      # Conversation SQLModel schema
â”‚   â”‚   â”œâ”€â”€ message.py           # Message SQLModel schema
â”‚   â”‚   â””â”€â”€ user.py              # User SQLModel schema (Better Auth integration)
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ server.py            # MCP server initialization (Official MCP SDK)
â”‚   â”‚   â””â”€â”€ tools/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ add_task.py      # add_task MCP tool
â”‚   â”‚       â”œâ”€â”€ list_tasks.py    # list_tasks MCP tool
â”‚   â”‚       â”œâ”€â”€ complete_task.py # complete_task MCP tool
â”‚   â”‚       â”œâ”€â”€ update_task.py   # update_task MCP tool
â”‚   â”‚       â””â”€â”€ delete_task.py   # delete_task MCP tool
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ orchestrator.py      # OpenAI Agents SDK orchestrator
â”‚   â”‚   â”œâ”€â”€ system_prompt.py     # System prompt configuration
â”‚   â”‚   â””â”€â”€ conversation_manager.py  # Conversation history retrieval/storage
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat.py              # POST /api/{user_id}/chat endpoint
â”‚   â”‚   â”œâ”€â”€ conversations.py     # GET/DELETE /api/{user_id}/conversations
â”‚   â”‚   â””â”€â”€ health.py            # GET /health endpoint
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ auth.py              # JWT validation middleware
â”‚       â””â”€â”€ error_handler.py     # Global error handling
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ test_mcp_tools.py    # Unit tests for MCP tools
â”‚   â”‚   â”œâ”€â”€ test_models.py       # Unit tests for SQLModel schemas
â”‚   â”‚   â””â”€â”€ test_validators.py   # Unit tests for input validation
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â”œâ”€â”€ test_chat_endpoint.py    # Integration tests for chat endpoint
â”‚   â”‚   â”œâ”€â”€ test_conversation_flow.py # Multi-turn conversation tests
â”‚   â”‚   â””â”€â”€ test_user_isolation.py   # User isolation security tests
â”‚   â””â”€â”€ e2e/
â”‚       â””â”€â”€ test_user_scenarios.py   # End-to-end tests for all user stories
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ alembic/                 # Database migration scripts
â”œâ”€â”€ .env.example                 # Environment variable template
â”œâ”€â”€ requirements.txt             # Python dependencies (generated from pyproject.toml)
â”œâ”€â”€ pyproject.toml               # UV package manager configuration
â””â”€â”€ README.md                    # Backend setup instructions

frontend/
â”œâ”€â”€ app/                         # OpenAI ChatKit application
â”‚   â”œâ”€â”€ layout.tsx               # Root layout with authentication
â”‚   â”œâ”€â”€ page.tsx                 # Chat interface page
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ chat/
â”‚           â””â”€â”€ route.ts         # API route proxy to backend
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ChatInterface.tsx        # OpenAI ChatKit chat component
â”‚   â””â”€â”€ AuthProvider.tsx         # Better Auth authentication provider
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth.ts                  # Better Auth client configuration
â”‚   â””â”€â”€ api.ts                   # Backend API client (chat endpoint calls)
â”œâ”€â”€ .env.local                   # Frontend environment variables
â”œâ”€â”€ package.json                 # Frontend dependencies
â””â”€â”€ README.md                    # Frontend setup instructions
```

**Structure Decision**: Web application structure selected because requirements specify frontend (OpenAI ChatKit) and backend (FastAPI) components. Backend handles all business logic, MCP server, and database operations. Frontend provides the chat interface and authentication UI. This separation enables independent deployment and scaling per constitution's stateless architecture principle.

## Complexity Tracking

> **No violations** - All constitution principles are satisfied without exceptions. No complexity tracking required.

## Phase 0: Research & Best Practices

### Research Topics

The following topics require investigation to resolve unknowns from Technical Context and ensure best practices:

1. **OpenAI Agents SDK Integration Patterns**
   - **Unknown**: How to structure agent with MCP tool calling
   - **Research Goal**: Official OpenAI Agents SDK documentation on tool integration
   - **Deliverable**: Example agent initialization code, tool registration pattern, error handling approach

2. **Official MCP SDK for Python**
   - **Unknown**: MCP server initialization, tool definition syntax, parameter validation
   - **Research Goal**: MCP SDK documentation and Python examples
   - **Deliverable**: MCP server setup pattern, tool schema structure, best practices for input validation

3. **Better Auth with JWT Plugin**
   - **Unknown**: JWT token generation, validation, and integration between frontend and backend
   - **Research Goal**: Better Auth documentation for Next.js frontend + FastAPI backend
   - **Deliverable**: Authentication flow diagram, JWT validation middleware pattern, environment variable configuration

4. **Neon PostgreSQL Connection Pooling**
   - **Unknown**: Optimal connection pool settings for serverless PostgreSQL
   - **Research Goal**: Neon best practices for Python/SQLModel applications
   - **Deliverable**: Database connection pattern, pool size recommendations, retry logic for transient errors

5. **SQLModel Best Practices**
   - **Unknown**: Relationship definitions, migration strategy, query optimization
   - **Research Goal**: SQLModel documentation on foreign keys, indexes, and Alembic integration
   - **Deliverable**: Model relationship patterns, index strategy, migration workflow

6. **Natural Language Intent Detection**
   - **Unknown**: System prompt engineering for task management domain
   - **Research Goal**: Best practices for agent prompts that handle CRUD operations
   - **Deliverable**: System prompt template, example intent detection patterns, ambiguity handling strategies

### Research Output Location

All research findings will be consolidated into `specs/001-chatbot/research.md` following this format:

```markdown
## Research Topic: [Topic Name]

### Decision Made
[What approach was chosen]

### Rationale
[Why this approach was selected]

### Alternatives Considered
[What other options were evaluated and why they were rejected]

### Implementation Guidance
[Concrete patterns, code examples, configuration settings]
```

## Phase 1: Design & Contracts

**Prerequisites**: `research.md` complete

### 1.1 Data Model Design (`data-model.md`)

Extract entities from feature spec and design database schema:

**Entities from Spec**:
- User (from FR-021 to FR-023: authentication required)
- Task (from FR-007 to FR-011: task CRUD operations)
- Conversation (from FR-013 to FR-015: conversation management)
- Message (from FR-016: message storage)

**Schema Design Considerations**:
- All tables include `user_id` foreign key for user isolation (constitution principle VI)
- All tables include `created_at` and `updated_at` timestamps (constitution principle V)
- Task table includes `completed` boolean status (FR-009)
- Message table includes `role` enum (user/assistant) per constitution's chat endpoint example
- Conversation table tracks `updated_at` for sorting recent conversations
- Use SQLModel for ORM with proper indexes on foreign keys and query fields

**Output**: `specs/001-chatbot/data-model.md` with complete SQLModel schema definitions

### 1.2 API Contracts (`contracts/api-endpoints.md`)

**Subagent**: ðŸ¤– Using **stateless-api-designer** subagent to design API endpoint specifications

Generate API endpoint contracts for:
- POST /api/{user_id}/chat (primary chat endpoint)
- GET /api/{user_id}/conversations (list conversations)
- GET /api/{user_id}/conversations/{conversation_id}/messages (get conversation history)
- DELETE /api/{user_id}/conversations/{conversation_id} (delete conversation)
- GET /health (health check endpoint)

Each endpoint specification will include:
- HTTP method, URL path, and parameters
- Request headers (Authorization: Bearer {JWT})
- Request body schema (JSON)
- Response body schema (JSON) with all status codes (200, 400, 401, 403, 404, 429, 500)
- Error response format (consistent structure)
- Authentication requirements (JWT validation)
- Authorization rules (user_id validation)
- Rate limiting specifications
- Idempotency documentation
- Example cURL commands

**Output**: `specs/001-chatbot/contracts/api-endpoints.md`

### 1.3 MCP Tool Contracts (`contracts/mcp-tools.md`)

**Subagent**: ðŸ¤– Using **mcp-builder** subagent to design MCP tool interfaces

Generate MCP tool specifications for:
- add_task (create new task)
- list_tasks (retrieve tasks with optional filtering by completion status)
- complete_task (mark task as done)
- update_task (modify task title and/or description)
- delete_task (remove task permanently)

Each tool specification will include:
- Tool name (snake_case format)
- Purpose (one-line description)
- Parameters (name, type, required/optional, validation rules, constraints)
- Return value structure (fields, types, example values)
- Validation rules (length limits, required fields, allowed values)
- Error cases (ValidationError, NotFoundError, AuthorizationError)
- Example input/output (concrete JSON examples for testing)
- Security notes (user isolation enforcement, input sanitization)
- Idempotency documentation

**Output**: `specs/001-chatbot/contracts/mcp-tools.md`

### 1.4 Agent Orchestrator Architecture (`contracts/agent-orchestrator.md`)

**Subagent**: ðŸ¤– Using **agent-orchestrator** subagent to design agent architecture

Generate orchestrator architecture specification including:
- Complete request-response flow (7 steps: reception, context retrieval, agent processing, tool invocation, response generation, state persistence, response return)
- System prompt design (agent personality, capabilities, behavior guidelines, tool usage patterns)
- Tool integration strategy (tool registration, invocation pattern, error handling, result processing)
- Context management (history retrieval strategy, context window limits, message formatting, token budget)
- Natural language generation approach (confirmation messages, error messages, conversational tone)
- Error handling for all scenarios (tool errors, AI service errors, database errors, validation errors, authentication errors)
- Security and isolation (user authentication flow, data isolation enforcement, input sanitization, rate limiting)
- Performance optimization (response time targets, parallel processing, connection pooling, timeout limits)
- Configuration (environment variables, feature flags)

**Output**: `specs/001-chatbot/contracts/agent-orchestrator.md`

### 1.5 Quickstart Guide (`quickstart.md`)

Create implementation quick reference with:
- Development environment setup (Python 3.13+, UV, environment variables)
- Database setup (Neon PostgreSQL connection, initial migration)
- Backend development workflow (run FastAPI server, run MCP server, run tests)
- Frontend development workflow (run ChatKit dev server, configure Better Auth)
- Testing strategy (unit tests for MCP tools, integration tests for endpoints, E2E tests for user stories)
- Deployment checklist (environment variables, database migrations, CORS configuration)

**Output**: `specs/001-chatbot/quickstart.md`

### 1.6 Agent Context Update

Run the context update script to add new technology to the appropriate agent-specific context file:

```bash
.specify/scripts/bash/update-agent-context.sh claude
```

This script will:
- Detect the AI agent in use (Claude)
- Update `.claude/context.md` (or equivalent)
- Add only new technology from this plan (OpenAI Agents SDK, MCP SDK, Better Auth)
- Preserve manual additions between markers

**Note**: Constitution Check will be re-evaluated after Phase 1 design is complete to verify no violations were introduced during detailed design.

## Phase 2: Task Generation

**Not performed by /sp.plan command**

After Phase 1 is complete, the user will run `/sp.tasks` command to:
- Read this plan.md, research.md, data-model.md, and all contracts/
- Generate tasks.md with concrete, testable implementation tasks
- Each task includes acceptance criteria, test cases, and implementation guidance
- Tasks are ordered by dependency (database models â†’ MCP tools â†’ API endpoints â†’ agent orchestrator â†’ frontend integration â†’ E2E tests)

---

## Next Steps

1. **Complete Phase 0**: Invoke research agents to resolve all unknowns listed in "Research Topics"
2. **Complete Phase 1**: Invoke specialized subagents to generate all design artifacts
3. **Re-verify Constitution Check**: Ensure design maintains compliance with all 7 principles
4. **Run /sp.tasks**: Generate implementation tasks from complete plan
5. **Implement via Claude Code**: Execute tasks in dependency order using spec-driven development

**Planning Status**: Phase 0 and Phase 1 in progress (research and design artifacts will be generated by subagents).
