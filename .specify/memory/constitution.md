<!--
Sync Impact Report:
Version Change: 1.0.0 (Initial)
Modified Principles: N/A (Initial creation)
Added Sections: All core principles for Phase 3
Removed Sections: None
Templates Requiring Updates:
  - ✅ .specify/templates/plan-template.md (aligned with AI-first principles)
  - ✅ .specify/templates/spec-template.md (aligned with conversational interface requirements)
  - ✅ .specify/templates/tasks-template.md (aligned with MCP and stateless architecture)
Follow-up TODOs: None - all principles defined for Phase 3
-->

# Todo AI Chatbot Constitution - Phase 3

## Core Principles

### I. Spec-Driven Development (NON-NEGOTIABLE)

**All code MUST be generated through the Spec-Driven Development workflow:**
- Write Specification → Generate Plan → Break into Tasks → Implement via Claude Code
- NO manual coding is permitted - code must be generated by refining specifications
- Every feature requires a complete spec before implementation begins
- All specifications must be stored in the `/specs` directory with proper versioning
- Constitution supersedes all other practices and coding preferences

**Rationale:** This hackathon is designed to master AI-driven development where engineers act as architects, not syntax writers. Manual coding defeats the learning objective.

### II. Conversational-First Interface

**The chatbot MUST understand and respond to natural language:**
- All Basic Level features (Add, Delete, Update, View, Mark Complete) must be accessible via conversation
- Users should never need to use explicit commands or syntax
- The AI must interpret user intent from context (e.g., "I need to buy groceries" → create task)
- Responses must confirm actions with friendly, human-like language
- Error handling must be graceful and conversational, not technical

**Rationale:** Phase 3 transitions from traditional UI to AI-native interaction, requiring natural language understanding as the primary interface.

### III. Stateless Architecture

**The backend MUST maintain NO state in memory:**
- All conversation history is stored in the database (Conversations and Messages tables)
- Every API request is independent and can be handled by any server instance
- Server restarts must not lose any conversation context
- The chat endpoint fetches history, processes the request, stores results, and returns
- This enables horizontal scaling and resilience

**Rationale:** Stateless architecture is essential for cloud-native applications and allows the system to scale across multiple instances without session affinity.

### IV. MCP Tool Architecture

**All task operations MUST be exposed as MCP tools:**
- Use the Official MCP SDK to build the MCP server
- Each CRUD operation (add, delete, update, list, complete) is a separate tool
- Tools must have clear schemas with required/optional parameters
- The OpenAI Agents SDK invokes MCP tools, not direct database calls
- Tools must validate inputs and return structured responses

**Rationale:** MCP (Model Context Protocol) provides a standardized way for AI agents to interact with applications, promoting modularity and reusability.

### V. Database as Single Source of Truth

**All state MUST be persisted to Neon PostgreSQL:**
- Tasks: user_id, id, title, description, completed, created_at, updated_at
- Conversations: user_id, id, created_at, updated_at
- Messages: user_id, id, conversation_id, role (user/assistant), content, created_at
- NO in-memory caching or session storage
- Use SQLModel for all database operations
- Database connection string from environment variable: DATABASE_URL

**Rationale:** Persistent storage in a serverless database ensures data durability and enables the stateless architecture required for cloud deployment.

### VI. Authentication and Security

**User authentication and data isolation are mandatory:**
- Implement Better Auth for user signup/signin
- All API endpoints require JWT token validation
- Each user can only access their own tasks and conversations
- JWT tokens must be verified on every request
- Shared secret (BETTER_AUTH_SECRET) between frontend and backend
- Never expose database credentials or API keys in code

**Rationale:** Multi-user applications require robust authentication to prevent unauthorized access and ensure data privacy.

### VII. AI Agent Integration

**Use OpenAI Agents SDK for all AI logic:**
- The agent receives conversation history + new user message
- Agent determines which MCP tool(s) to call based on user intent
- Agent composes natural language responses
- NO hardcoded if/else logic for intent detection
- Let the LLM handle natural language understanding
- Model: Configurable (default: gpt-4o or gpt-4o-mini)

**Rationale:** The OpenAI Agents SDK provides robust agent orchestration with built-in tool calling, allowing the LLM to intelligently route requests to the appropriate tools.

## Technology Stack Requirements

### Frontend
- **Framework:** OpenAI ChatKit
- **Hosting:** Vercel (free tier acceptable)
- **Authentication:** Better Auth with JWT plugin
- **Environment:** Must configure OpenAI domain allowlist before deployment

### Backend
- **Framework:** Python FastAPI
- **ORM:** SQLModel
- **Database:** Neon Serverless PostgreSQL
- **AI Framework:** OpenAI Agents SDK
- **MCP Server:** Official MCP SDK (Python)
- **Python Version:** 3.13+ with UV package manager

### Deployment
- **Local Development:** Must work on localhost
- **Production:** Vercel (frontend), suitable Python hosting (backend)
- **Environment Variables:** Must use .env files, never hardcode secrets

## API Design Standards

### Chat Endpoint
**POST /api/{user_id}/chat**

Request:
```json
{
  "conversation_id": 123,  // Optional - creates new if not provided
  "message": "Add a task to buy groceries"
}
```

Response:
```json
{
  "conversation_id": 123,
  "response": "I've added 'Buy groceries' to your task list.",
  "tool_calls": [{"tool": "add_task", "result": {...}}]
}
```

### MCP Tools Schema
Each tool must follow this structure:
- **Purpose:** Clear description of what the tool does
- **Parameters:** Explicit schema with types and required/optional flags
- **Returns:** Structured response format
- **Example Input/Output:** Concrete examples for testing

## Agent Behavior Contract

### Intent Detection
The agent MUST recognize these patterns:
- **Task Creation:** "add", "create", "remember", "I need to"
- **Task Listing:** "show", "list", "what", "view"
- **Task Completion:** "done", "complete", "finished", "mark"
- **Task Deletion:** "delete", "remove", "cancel"
- **Task Update:** "change", "update", "rename", "modify"

### Response Guidelines
- Always confirm actions with natural language
- Include task title in confirmation
- Handle errors gracefully (e.g., "I couldn't find that task")
- Don't expose technical details to users
- Use conversational tone, not robotic

## Testing Requirements

### Unit Tests
- All MCP tools must have unit tests
- Test valid inputs, invalid inputs, edge cases
- Test database constraints (e.g., user isolation)

### Integration Tests
- Test chat endpoint with various natural language inputs
- Test conversation history persistence and retrieval
- Test stateless behavior (server restart doesn't lose data)

### User Acceptance Tests
- Verify all natural language commands work correctly
- Test error scenarios (task not found, invalid task ID)
- Verify multi-turn conversations maintain context

## Non-Functional Requirements

### Performance
- Chat endpoint response time: < 3 seconds (p95)
- Database queries: < 500ms
- Support concurrent conversations

### Reliability
- Handle OpenAI API failures gracefully
- Retry transient database errors
- Validate all user inputs

### Security
- Never log sensitive information (JWT tokens, passwords)
- Sanitize all user inputs to prevent injection attacks
- Use parameterized queries for all database operations

## Documentation Requirements

### Repository Structure
```
/
├── .specify/
│   ├── memory/
│   │   └── constitution.md (this file)
│   └── templates/
├── specs/
│   ├── phase3/
│   │   ├── spec.md
│   │   ├── plan.md
│   │   └── tasks.md
├── history/
│   └── prompts/
├── frontend/
│   └── (OpenAI ChatKit app)
├── backend/
│   ├── main.py (FastAPI app)
│   ├── models.py (SQLModel schemas)
│   ├── mcp_server.py (MCP tool definitions)
│   └── routes/
│       └── chat.py
├── README.md
└── CLAUDE.md
```

### README.md Must Include
- Setup instructions for both frontend and backend
- Environment variable configuration
- Database migration steps
- How to run locally
- How to deploy to production

### CLAUDE.md Must Include
- Reference to this constitution
- Spec-driven workflow instructions
- Links to specs and templates
- Technology stack overview

## Governance

### Amendment Process
1. Identify principle or constraint requiring change
2. Document rationale and impact in GitHub issue
3. Update constitution with version bump:
   - **MAJOR:** Breaking changes to architecture or principles
   - **MINOR:** New principle or section added
   - **PATCH:** Clarifications or typo fixes
4. Update dependent templates (plan, spec, tasks)
5. Update Sync Impact Report at top of file
6. Commit with message: `docs: amend constitution to vX.Y.Z (<summary>)`

### Compliance Verification
- All pull requests must reference applicable principles
- Code reviews must verify alignment with constitution
- Agents must check constitution before proposing solutions
- Constitution violations require justification or rejection

### Version History
**Version**: 1.0.0
**Ratified**: 2025-12-18
**Last Amended**: 2025-12-18

---

**This constitution governs Phase 3: AI-Powered Todo Chatbot.**
**All development must align with these principles.**
**When in doubt, refer to this document as the source of truth.**
